name: GitHub Mode Agent Run

on:
  workflow_dispatch:
    inputs:
      command:
        description: "Agent command to execute (explain, refactor, test, diagram)"
        required: true
        type: choice
        options:
          - explain
          - refactor
          - test
          - diagram
      target:
        description: "Target file or path for the agent run"
        required: true
        type: string
      run_context:
        description: "Optional JSON context for the agent run"
        required: false
        type: string
        default: "{}"
  workflow_call:
    inputs:
      command:
        required: true
        type: string
      target:
        required: true
        type: string
      run_context:
        required: false
        type: string
        default: "{}"

permissions:
  contents: read

jobs:
  pre-agent-gates:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      gates_passed: ${{ steps.gates.outputs.passed }}
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
      - uses: ./.github/actions/setup-node-env
      - name: Enforce GitHub Mode activation
        run: node --import tsx .GITHUB-MODE/scripts/check-github-mode-active.ts

      - name: Run pre-agent gates (fail-closed)
        id: gates
        env:
          GITHUB_MODE_COMMAND: ${{ inputs.command }}
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/github-mode-agent-run"
          if node --import tsx .GITHUB-MODE/scripts/run-pre-agent-gates.ts \
            --json-out "$RUNNER_TEMP/github-mode-agent-run/gate-records.json" \
            --summary-out "$RUNNER_TEMP/github-mode-agent-run/gate-summary.md" \
            | tee "$RUNNER_TEMP/github-mode-agent-run/gates-output.txt"; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
            echo "::error::Pre-agent gates failed. Agent execution blocked."
            exit 1
          fi

      - name: Publish pre-agent gate records
        if: always()
        run: |
          {
            echo ""
            echo "### Pre-agent gate records"
            jq -r '.gates[] | "- gate=\(.gate) result=\(.result) reason=\(.reason) evidence=\(.evidence)"' \
              "$RUNNER_TEMP/github-mode-agent-run/gate-records.json"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Emit gate evidence
        if: always()
        run: |
          mkdir -p "$RUNNER_TEMP/github-mode-agent-run"
          cat > "$RUNNER_TEMP/github-mode-agent-run/evidence.json" <<EOF
          {
            "workflow": "github-mode-agent-run",
            "command": "${{ inputs.command }}",
            "target": "${{ inputs.target }}",
            "gates_passed": "${{ steps.gates.outputs.passed }}",
            "result": "${{ steps.gates.outputs.passed == 'true' && 'pass' || 'fail' }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_id": "${{ github.run_id }}",
            "sha": "${{ github.sha }}",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: Publish agent run summary
        if: always()
        run: |
          {
            echo "## GitHub Mode Agent Run"
            echo ""
            echo "- Command: \`${{ inputs.command }}\`"
            echo "- Target: \`${{ inputs.target }}\`"
            echo "- Actor: \`${{ github.actor }}\`"
            echo "- Gates: ${{ steps.gates.outputs.passed == 'true' && '✅ Passed' || '❌ Failed' }}"
            echo "- Run ID: \`${{ github.run_id }}\`"
            echo "- Commit: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload gate evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: github-mode-agent-run-gate-evidence
          path: ${{ runner.temp }}/github-mode-agent-run/
          retention-days: 90

  agent-execution:
    needs: pre-agent-gates
    if: needs.pre-agent-gates.outputs.gates_passed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
      - uses: ./.github/actions/setup-node-env

      - name: Build openclaw runtime from source
        run: pnpm build

      - name: Enforce trust-aware authorization (Task 4.2)
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_MODE_TRUST_LEVEL: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork && 'untrusted' || 'trusted' }}
          GITHUB_MODE_ADAPTER: repo-write
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/github-mode-agent-auth"
          node --import tsx .GITHUB-MODE/scripts/enforce-trust-authorization.ts \
            --json-out "$RUNNER_TEMP/github-mode-agent-auth/authorization-decision.json" \
            --summary-out "$RUNNER_TEMP/github-mode-agent-auth/authorization-summary.md"

      - name: Upload trust authorization evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: github-mode-agent-authorization-evidence
          path: ${{ runner.temp }}/github-mode-agent-auth/
          retention-days: 90

      - name: Enforce policy-gated adapter invocation (Task 4.3)
        env:
          GITHUB_MODE_ADAPTER: repo-write
          GITHUB_MODE_ACTION: open-pr
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/github-mode-agent-policy-gate"
          node --import tsx .GITHUB-MODE/scripts/enforce-policy-gated-adapter.ts \
            --json-out "$RUNNER_TEMP/github-mode-agent-policy-gate/policy-decision.json" \
            --summary-out "$RUNNER_TEMP/github-mode-agent-policy-gate/policy-summary.md"

      - name: Upload policy-gated adapter evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: github-mode-agent-policy-gate-evidence
          path: ${{ runner.temp }}/github-mode-agent-policy-gate/
          retention-days: 90

      - name: Validate provenance metadata (Task 4.4)
        env:
          GITHUB_MODE_COMMAND: ${{ inputs.command }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          set -euo pipefail
          mkdir -p "$RUNNER_TEMP/github-mode-agent-provenance"
          node --import tsx .GITHUB-MODE/scripts/validate-provenance-metadata.ts \
            --json-out "$RUNNER_TEMP/github-mode-agent-provenance/provenance-validation.json" \
            --summary-out "$RUNNER_TEMP/github-mode-agent-provenance/provenance-summary.md"

      - name: Upload provenance validation evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: github-mode-agent-provenance-evidence
          path: ${{ runner.temp }}/github-mode-agent-provenance/
          retention-days: 90

      - name: Execute agent via openclaw agent engine
        env:
          GITHUB_MODE_COMMAND: ${{ inputs.command }}
          GITHUB_MODE_TARGET: ${{ inputs.target }}
          GITHUB_MODE_RUN_CONTEXT: ${{ inputs.run_context }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          echo "Executing: $GITHUB_MODE_COMMAND on $GITHUB_MODE_TARGET via openclaw agent engine"
          node openclaw.mjs agent \
            --agent main \
            --message "$GITHUB_MODE_COMMAND $GITHUB_MODE_TARGET" \
            --local \
            --json

      - name: Emit agent run evidence
        run: |
          mkdir -p "$RUNNER_TEMP/github-mode-agent-execution"
          cat > "$RUNNER_TEMP/github-mode-agent-execution/evidence.json" <<EOF
          {
            "workflow": "github-mode-agent-run",
            "phase": "execution",
            "command": "${{ inputs.command }}",
            "target": "${{ inputs.target }}",
            "result": "pass",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "run_id": "${{ github.run_id }}",
            "sha": "${{ github.sha }}",
            "provenance": {
              "source_command": "${{ inputs.command }}",
              "commit_sha": "${{ github.sha }}",
              "run_id": "${{ github.run_id }}",
              "policy_version": "v1.0.0"
            }
          }
          EOF
      - name: Upload agent run evidence
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: github-mode-agent-run-execution-evidence
          path: ${{ runner.temp }}/github-mode-agent-execution/evidence.json
          retention-days: 90
